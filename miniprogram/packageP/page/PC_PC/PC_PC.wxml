<scroll-view class="sv_list" scroll-x="true" scroll-y="true" style="height:88%">
  <!-- 顶部查询区域 -->
  <view style="background: linear-gradient(135deg, #5a7592 0%, #3a4a6c 100%);border-radius: 16rpx;padding: 20rpx;margin: 20rpx;color: white;">
    <view style="padding: 20rpx;">
      <view style="margin-bottom: 20rpx;">
        <text style="font-size: 32rpx;font-weight: 600;color: white;margin-bottom: 10rpx;display: block;">订单号</text>
        <picker 
          style="background: rgba(255, 255, 255, 0.9);border: 1px solid #b8d8e6;border-radius: 10px;margin: 0 15px 15px 15px;font-size: 15px;color: #2c3e50;box-shadow: inset 0 1px 3px rgba(139, 197, 216, 0.2), 0 2px 4px rgba(139, 197, 216, 0.1);padding: 12px 15px;" 
          range="{{orderList}}" 
          range-key="order_id" 
          value="-1" 
          bindchange="onOrderChange">
          <view style="color: #333; font-size: 28rpx;">
            {{orderList[orderIndex] ? orderList[orderIndex].order_id : '请选择订单号'}}
          </view>
        </picker>
      </view>
      
      <view class="bottom_view" style="height: 10%;  left: 0rpx;margin-top:20rpx">
        <button class="bt_bottom" hover-class="bt_bottom_hover" bindtap="getList">
          查询
        </button>
        <button class="bt_bottom" hover-class="bt_bottom_hover" bindtap="resetQuery">
          刷新
        </button>
        <button class="bt_bottom" hover-class="bt_bottom_hover" bindtap="openAddDialog" disabled="{{!hasAddPermission}}">
          新增
        </button>
        <button class="bt_bottom" hover-class="bt_bottom_hover" bindtap="calculatePaichan">
          重算
        </button>
      </view>
    </view>
  </view>

  <!-- 主表格 -->
  <view style="width: 100%; overflow-x: auto;">
  <view class="table" style="margin: 0 20rpx;">
    <view class='table_header'>
      <block class="title" wx:for="{{title}}">
        <view class="title_text" style="width:{{item.width}};{{item.text==''?'position:sticky;left:0;z-index:5':''}}">
          {{item.text}}
        </view>
      </block>
    </view>
    
    <block class="list_row" wx:for="{{list}}" wx:for-item="list_item" wx:for-index="i" wx:key="id">
  <view class="table_main">
    <view wx:for="{{title}}" 
          wx:for-item="item" 
          wx:key="columnName" 
          class="list_view" 
          style="width:{{item.width}}" 
          data-index="{{i}}" 
          data-column="{{item.columnName}}" 
          data-value="{{list_item[item.columnName]}}" 
          bindtap="clickView">
      <view class="list_text">
        <text wx:if="{{item.columnName == 'rownum'}}">{{list_item.rownum || i+1}}</text>
        <text wx:elif="{{item.columnName == 'order_id'}}">{{list_item.order_number || formatOrderId(list_item.order_id)}}</text>
        <text wx:elif="{{item.columnName == 'work_num'}}">{{list_item.work_num}}</text>
        <text wx:elif="{{item.columnName == 'work_start_date'}}">{{list_item.work_start_date}}</text>
        <text wx:elif="{{item.columnName == 'jiezhishijian'}}">{{list_item.jiezhishijian}}</text>
        <text wx:elif="{{item.columnName == 'paichanEndTime'}}">{{list_item.paichanEndTime}}</text>
        <text wx:elif="{{item.columnName == 'type'}}">{{list_item.type == "urgent" ? '优先' : '正常'}}</text>
        <text wx:elif="{{item.columnName == 'is_insert'}}">{{list_item.is_insert == 1 ? '是' : '否'}}</text>
        <text wx:elif="{{item.columnName == 'action'}}">删除</text>
        <text wx:else>{{list_item[item.columnName] || ''}}</text>
      </view>
    </view>
  </view>
</block>
  </view>
</view>
  <!-- 分页 -->
  <view class="pagination bottom_view" style="height: 10%;  left: 0rpx;">
    <picker 
      class="input_text_form_small" 
      range="{{[10, 20, 50, 100]}}" 
      value="{{pageSizeIndex}}" 
      bindchange="onPageSizeChange">
      <view>{{pageSize}}条/页</view>
    </picker>
    
    <text class="page-info">{{pageNow}}/{{totalPages}}</text>
    
    <button class="bt_bottom" style="width:18%" bindtap="prevPage" disabled="{{pageNow === 1}}">
      上一页
    </button>
    <button class="bt_bottom" style="width:18%" bindtap="nextPage" disabled="{{pageNow >= Math.ceil(total/pageSize)}}">
      下一页
    </button>
  </view>

<!-- 排产结果表格 -->
<view style="width: 100%; overflow-x: auto;">
<view class="table" style="margin:20rpx">
  <text style="font-size:32rpx;font-weight:bold;color:#fff;display:block;margin-bottom:20rpx;">排产结果 ({{paichanResult.length}}条)</text>
  
  <view class='table_header'>
    <block class="title" wx:for="{{resultTitle}}">
      <view class="title_text" style="width:{{item.width}}">
        {{item.text}}
      </view>
    </block>
  </view>
  
  <block class="list_row" wx:for="{{paichanResult}}" wx:for-item="result_item" wx:for-index="i" wx:key="index">
    <view class="table_main">
      <view wx:for="{{resultTitle}}" 
            wx:for-item="item" 
            wx:key="item" 
            class="list_view" 
            style="width:{{item.width}}">
        <view class="list_text" 
              style="{{result_item.isInsert ? 'color:#ff6b6b;font-weight:bold;' : result_item.isUrgent ? 'color:#ffa726;font-weight:bold;' : ''}}">
          <text wx:if="{{item.columnName == 'orderId'}}">{{result_item.orderId}}</text>
          <text wx:elif="{{item.columnName == 'priority'}}">{{result_item.priority}}</text>
          <text wx:elif="{{item.columnName == 'processName'}}">{{result_item.processName}}</text>
          <text wx:elif="{{item.columnName == 'quantity'}}">{{result_item.quantity}}</text>
          <text wx:elif="{{item.columnName == 'processEfficiency'}}">{{result_item.processEfficiency}}</text>
          <text wx:elif="{{item.columnName == 'productionLine'}}">{{result_item.productionLine}}</text>
          <text wx:elif="{{item.columnName == 'requiredHours'}}">{{result_item.requiredHours}}</text>
          <text wx:elif="{{item.columnName == 'startTime'}}">{{result_item.startTime}}</text>
          <text wx:elif="{{item.columnName == 'endTime'}}">{{result_item.endTime}}</text>
          <text wx:elif="{{item.columnName == 'status'}}">{{result_item.warning ? '超期' : '正常'}}</text>
          <text wx:elif="{{item.columnName == 'type'}}">{{result_item.isInsert ? '插单' : '正常'}}</text>
          <text wx:else>{{result_item[item.columnName] || ''}}</text>
        </view>
      </view>
    </view>
  </block>
  
  <!-- 空状态 -->
  <view wx:if="{{paichanResult.length === 0}}" style="text-align:center;padding:60rpx;color:#999;">
    暂无排产结果
  </view>
</view>
</view>
<!------------------------->
<!---------新增弹窗--------->
<!------------------------->
<van-popup bind:click-overlay="closeAddDialog" show="{{ addDialogVisible }}" position="bottom" custom-style="height: 80%;">
  <view class="input_view">
    <view class="lables">订单号</view>
    <picker 
      class="input_text_form" 
      range="{{orderList}}" 
      range-key="order_id" 
      value="-1" 
      bindchange="onNewOrderChange">
      <view class="picker-value">
        {{orderList[newItem.orderIndex] ? orderList[newItem.orderIndex].order_id : '请选择订单号'}}
      </view>
    </picker>
    <view wx:if="{{selectedOrderNum > 0}}" class="order-info" style="font-size: 24rpx;color: #666;margin-top: 10rpx;margin-left: 90rpx;">
      可生产数量：{{selectedOrderNum}}
    </view>
    
    <view class="lables">排产数量</view>
<view 
  class="input_text_form" 
  style="padding: 20rpx; color: #333;"
  bindtap="openWorkNumEdit">
  {{newItem.work_num || '请输入排产数量'}}
</view>
    
    <view class="lables">类型</view>
    <picker 
      class="input_text_form" 
      range="{{typeOptions}}" 
      value="{{newItem.typeIndex}}" 
      bindchange="onTypeChange">
      <view class="picker-value">
        {{typeOptions[newItem.typeIndex]}}
      </view>
    </picker>
    
    <view class="lables">是否插入</view>
    <picker 
      class="input_text_form" 
      range="{{insertOptions}}" 
      value="{{newItem.insertIndex}}" 
      bindchange="onInsertChange">
      <view class="picker-value">
        {{insertOptions[newItem.insertIndex]}}
      </view>
    </picker>
    
    <!-- 开始日期 - 借鉴排班页面的方式 -->
    <view class="lables">开始日期</view>
    <picker class="pick" mode="date" value="{{newItem.work_start_date}}" data-column_name="work_start_date" bindchange="choiceDate" data-type="start">
      <input bindinput="onInputDate" data-column="work_start_date" class="input_text_form" value="{{newItem.work_start_date}}" type="text" name="work_start_date" disabled="disabled"></input>
    </picker>
    
    <!-- 截止日期 - 借鉴排班页面的方式 -->
    <view class="lables">截止日期</view>
    <picker class="pick" mode="date" value="{{deadlineDate}}" data-column_name="deadlineDate" bindchange="choiceDate" data-type="deadline">
      <input bindinput="onInputDate" data-column="deadlineDate" class="input_text_form" value="{{deadlineDate}}" type="text" name="deadlineDate" disabled="disabled"></input>
    </picker>
    
    <view class="bottom_view" style="height:10%">
      <button class="bt_bottom" hover-class="bt_bottom_hover" bindtap="closeAddDialog">取消</button>
      <button class="bt_bottom" hover-class="bt_bottom_hover" bindtap="addItem">确定</button>
    </view>
  </view>
</van-popup>

<!--------------------->
<!--------删除确认-------->
<!--------------------->
<van-dialog 
  use-slot
  title="确认删除该排产订单？"
  show="{{ deleteConfirmVisible }}" 
  bind:close="closeDeleteConfirm" 
  closeOnClickOverlay="true"
  show-confirm-button="true" 
  show-cancel-button="true" 
  bind:confirm="confirmDelete">
</van-dialog>

<!------------------------->
<!---------超期提醒弹窗--------->
<!------------------------->
<van-popup bind:click-overlay="closeOverdueDialog" show="{{ overdueVisible }}" position="bottom" custom-style="height: 60%;">
  <view class="input_view">
    <view class="lables" style="color:#ff6b6b;text-align:center">排产超期提醒</view>
    <scroll-view scroll-y style="height:300rpx;margin:20rpx;font-size: 28rpx;line-height: 1.6;color: #333;white-space: pre-line;">
      <text>{{overdueMessage}}</text>
    </scroll-view>
    <view class="bottom_view" style="height:10%">
      <button class="bt_bottom" hover-class="bt_bottom_hover" bindtap="closeOverdueDialog">确定</button>
    </view>
  </view>
</van-popup>

<!-- 加载中 -->
<view wx:if="{{isCalculating || loading}}" class="mask">
  <view style="position: absolute;top: 50%;left: 50%;transform: translate(-50%, -50%);text-align: center;">
    <view style="width: 80rpx;height: 80rpx;border: 6rpx solid rgba(255, 255, 255, 0.3);border-top: 6rpx solid #5a7592;border-radius: 50%;animation: spin 1s linear infinite;margin: 0 auto;"></view>
    <text style="color:white;margin-top:20rpx;display:block">
      {{isCalculating ? '计算排产中...' : '加载中...'}}
    </text>
  </view>
</view>
</scroll-view>