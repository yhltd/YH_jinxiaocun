<view class="container">
  <!-- æ—¥å†å¤´éƒ¨ -->
  <view class="calendar-header">
    <view class="calendar-nav">
      <text class="nav-btn" bindtap="prevMonth">â€¹</text>
      <text class="current-month">{{currentYear}}å¹´{{currentMonth}}æœˆ</text>
      <text class="nav-btn" bindtap="nextMonth">â€º</text>
    </view>
    <view class="week-header">
      <text class="week-day">ä¸€</text>
      <text class="week-day">äºŒ</text>
      <text class="week-day">ä¸‰</text>
      <text class="week-day">å››</text>
      <text class="week-day">äº”</text>
      <text class="week-day">å…­</text>
      <text class="week-day">æ—¥</text>
    </view>
  </view>

  <!-- æ—¥å†ç½‘æ ¼ -->
  <view class="calendar-grid">
    <block wx:for="{{calendarDays}}" wx:key="index">
      <view 
        class="calendar-day {{item.isCurrentMonth ? 'current-month' : 'other-month'}} {{item.isToday ? 'today' : ''}} {{item.isSelected ? 'selected' : ''}} {{item.hasSchedule ? 'has-schedule' : ''}}"
        bindtap="selectDate"
        data-index="{{index}}"
        data-datestr="{{item.dateStr}}"
      >
        <text class="day-text">{{item.day}}</text>
        <text wx:if="{{item.hasSchedule}}" class="schedule-dot"></text>
        <text wx:if="{{item.scheduleCount > 1}}" class="schedule-count">{{item.scheduleCount}}</text>
      </view>
    </block>
  </view>

  <!-- é€‰ä¸­çš„æ—¥æœŸ -->
  <view wx:if="{{selectedDates.length > 0}}" class="selected-dates">
    <text class="label">å·²é€‰æ—¥æœŸï¼š</text>
    <scroll-view scroll-x class="dates-scroll">
      <block wx:for="{{selectedDates}}" wx:key="index">
        <text class="date-tag">{{item}}</text>
      </block>
    </scroll-view>
  </view>

  <!-- æ—¶é—´è®¾ç½®é¢æ¿ -->
  <view wx:if="{{showTimePicker}}" class="time-panel">
    <view class="panel-title">å·¥ä½œæ—¶é—´è®¾ç½®</view>
    
    <!-- éƒ¨é—¨ -->
    <view class="form-group">
      <text class="form-label">éƒ¨é—¨</text>
      <input 
        class="form-input" 
        placeholder="è¯·è¾“å…¥éƒ¨é—¨" 
        value="{{scheduleTitle}}" 
        bindinput="onScheduleTitleInput"
      />
    </view>

    <!-- æ—¶é—´èŒƒå›´ -->
    <view class="form-group">
      <text class="form-label">å·¥ä½œæ—¶é—´</text>
      <picker 
        mode="multiSelector" 
        range="{{timeRanges}}" 
        value="{{timeIndex}}" 
        bindchange="onTimeChange"
      >
        <view class="picker-text">{{startTime}} - {{endTime}}</view>
      </picker>
    </view>

    <!-- åˆä¼‘æ—¶é—´ -->
    <view class="form-group">
      <text class="form-label">åˆä¼‘æ—¶é—´</text>
      <view class="break-time-group">
        <picker 
          mode="time" 
          value="{{breakStart}}" 
          bindchange="onBreakChange"
          data-field="breakStart"
        >
          <view class="time-picker">{{breakStart}}</view>
        </picker>
        <text class="time-separator">è‡³</text>
        <picker 
          mode="time" 
          value="{{breakEnd}}" 
          bindchange="onBreakChange"
          data-field="breakEnd"
        >
          <view class="time-picker">{{breakEnd}}</view>
        </picker>
      </view>
    </view>

    <!-- æ“ä½œæŒ‰é’® -->
    <view class="action-buttons">
      <button class="btn-cancel" bindtap="resetForm">å–æ¶ˆ</button>
      <button class="btn-save" type="primary" bindtap="saveSchedule">ä¿å­˜å®‰æ’</button>
    </view>
  </view>

  <!-- æ—¶é—´ç¼–è¾‘å¼¹çª— -->
<tui-modal 
  show="{{showTimeEditModal}}" 
  bind:cancel="hideTimeEditModal" 
  custom="{{true}}" 
  fadein="{{true}}"
  width="90%"
>
  <view class="time-edit-modal">
    <view class="modal-title">
      {{timeEditField === 'gongzuoshijian' ? 'ç¼–è¾‘å·¥ä½œæ—¶é—´' : 'ç¼–è¾‘åˆä¼‘æ—¶é—´'}}
    </view>
    
    <!-- å·¥ä½œæ—¶é—´ç¼–è¾‘ï¼ˆä½¿ç”¨å¤šåˆ—é€‰æ‹©å™¨ï¼‰ -->
    <view wx:if="{{timeEditField === 'gongzuoshijian'}}" class="form-group">
      <text class="form-label">å·¥ä½œæ—¶é—´</text>
      <picker 
        mode="multiSelector" 
        range="{{editTimeRanges}}" 
        value="{{editTimeIndex}}" 
        bindchange="onEditTimeChange"
      >
        <view class="picker-text">{{timeEditStart}} - {{timeEditEnd}}</view>
      </picker>
    </view>
    
    <!-- åˆä¼‘æ—¶é—´ç¼–è¾‘ï¼ˆä½¿ç”¨ä¸¤ä¸ªç‹¬ç«‹çš„æ—¶é—´é€‰æ‹©å™¨ï¼‰ -->
    <view wx:if="{{timeEditField === 'wuxiushijian'}}" class="form-group">
      <text class="form-label">åˆä¼‘æ—¶é—´</text>
      <view class="break-time-group">
        <picker 
          mode="time" 
          value="{{timeEditStart}}" 
          bindchange="onEditBreakChange"
          data-field="breakStart"
        >
          <view class="time-picker">{{timeEditStart}}</view>
        </picker>
        <text class="time-separator">è‡³</text>
        <picker 
          mode="time" 
          value="{{timeEditEnd}}" 
          bindchange="onEditBreakChange"
          data-field="breakEnd"
        >
          <view class="time-picker">{{timeEditEnd}}</view>
        </picker>
      </view>
    </view>
    
    <!-- å½“å‰æ—¶é—´æ˜¾ç¤º -->
    <view class="current-time">
      <text>å½“å‰æ—¶é—´ï¼š{{timeEditStart}} - {{timeEditEnd}}</text>
    </view>
    
    <!-- æ“ä½œæŒ‰é’® -->
    <view class="modal-actions">
      <button class="btn-modal-cancel" bindtap="hideTimeEditModal">å–æ¶ˆ</button>
      <button class="btn-modal-save" type="primary" bindtap="saveTimeEdit">ä¿å­˜ä¿®æ”¹</button>
    </view>
  </view>
</tui-modal>

  <!-- å·¥ä½œå®‰æ’åˆ—è¡¨ -->
<view class="schedule-list">
  <view class="section-title">å·¥ä½œå®‰æ’åˆ—è¡¨</view>
  <block wx:for="{{scheduleList}}" wx:key="id">
    <view class="schedule-item" style="border-left: 6rpx solid {{item.schedule_color}};">
      <view class="schedule-header">
        <text class="schedule-title">{{item.schedule_title}}</text>
        <!-- ä¿®æ”¹ï¼šå·¥ä½œæ—¶é—´å˜ä¸ºå¯ç‚¹å‡»ç¼–è¾‘ -->
        <text class="schedule-time" bindtap="editSchedule" data-schedule="{{item}}" data-field="gongzuoshijian">
          {{item.gongzuoshijianks}} - {{item.gongzuoshijianjs}}
        </text>
      </view>
      
      <view class="schedule-details">
        <!-- ä¿®æ”¹ï¼šæ—¥æœŸç¼–è¾‘ -->
        <text class="schedule-date" bindtap="editSchedule" data-schedule="{{item}}" data-field="work_days">
          ğŸ“… ç‚¹å‡»ç¼–è¾‘æ—¥æœŸï¼ˆ{{item.work_days && item.work_days.length ? item.work_days.length : 0}}å¤©ï¼‰
        </text>
        <!-- ä¿®æ”¹ï¼šåˆä¼‘æ—¶é—´å˜ä¸ºå¯ç‚¹å‡»ç¼–è¾‘ -->
        <text class="schedule-break" bindtap="editSchedule" data-schedule="{{item}}" data-field="wuxiushijian">
          åˆä¼‘ï¼š{{item.wuxiushijianks}} - {{item.wuxiushijianjs}}
        </text>
      </view>
      
      <view class="schedule-footer">
        <text class="schedule-repeat">{{getRepeatLabel(item.repeat_type)}}</text>
        <button class="btn-delete" size="mini" bindtap="deleteSchedule" data-id="{{item.id}}">åˆ é™¤</button>
      </view>
    </view>
  </block>
</view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-bar">
    <button class="btn-range" bindtap="showDateRangeModal">æ—¥æœŸèŒƒå›´é€‰æ‹©</button>
    <button class="btn-export" bindtap="exportExcel">å¯¼å‡ºExcel</button>
    <button class="btn-add" type="primary" bindtap="toggleTimePicker">
      {{showTimePicker ? 'æ”¶èµ·è®¾ç½®' : 'æ–°å»ºå®‰æ’'}}
    </button>
  </view>

  <!-- æ—¥æœŸèŒƒå›´é€‰æ‹©å¼¹çª— -->
  <tui-modal 
    show="{{showDateRangeModal}}" 
    bind:cancel="hideDateRangeModal" 
    custom="{{true}}" 
    fadein="{{true}}"
    width="90%"
  >
    <view class="date-range-modal">
      <view class="modal-title">é€‰æ‹©æ—¥æœŸèŒƒå›´</view>
      
      <!-- èµ·å§‹æ—¥æœŸ -->
      <view class="form-group">
        <text class="form-label">èµ·å§‹æ—¥æœŸ</text>
        <picker 
          mode="date" 
          value="{{rangeStartDate}}" 
          bindchange="onRangeStartChange"
        >
          <view class="picker-text">{{rangeStartDate}}</view>
        </picker>
      </view>
      
      <!-- æˆªæ­¢æ—¥æœŸ -->
      <view class="form-group">
        <text class="form-label">æˆªæ­¢æ—¥æœŸ</text>
        <picker 
          mode="date" 
          value="{{rangeEndDate}}" 
          bindchange="onRangeEndChange"
        >
          <view class="picker-text">{{rangeEndDate}}</view>
        </picker>
      </view>
      
      <!-- æ—¥æœŸç­›é€‰é€‰é¡¹ -->
      <view class="filter-options">
        <text class="options-title">æ—¥æœŸç­›é€‰ï¼š</text>
        <view class="option-group">
          <radio-group bindchange="onFilterOptionChange">
            <view class="option-item">
              <radio value="all" checked="{{filterOption === 'all'}}" color="#1890ff" />
              <text class="option-label">å…¨é€‰</text>
            </view>
            <view class="option-item">
              <radio value="excludeSat" checked="{{filterOption === 'excludeSat'}}" color="#1890ff" />
              <text class="option-label">æ’é™¤å‘¨å…­</text>
            </view>
            <view class="option-item">
              <radio value="excludeSun" checked="{{filterOption === 'excludeSun'}}" color="#1890ff" />
              <text class="option-label">æ’é™¤å‘¨æ—¥</text>
            </view>
            <view class="option-item">
              <radio value="weekends" checked="{{filterOption === 'weekends'}}" color="#1890ff" />
              <text class="option-label">ä»…åŒä¼‘æ—¥</text>
            </view>
            <view class="option-item">
              <radio value="weekdays" checked="{{filterOption === 'weekdays'}}" color="#1890ff" />
              <text class="option-label">ä»…å·¥ä½œæ—¥</text>
            </view>
          </radio-group>
        </view>
      </view>
      
      <!-- é¢„è§ˆåŒºåŸŸ -->
      <view class="preview-section">
        <text class="preview-title">é¢„è§ˆï¼ˆå…± {{filteredDates.length}} å¤©ï¼‰ï¼š</text>
        <scroll-view scroll-y class="preview-dates" style="max-height: 200rpx;">
          <view class="preview-grid">
            <block wx:for="{{filteredDates}}" wx:for-item="date" wx:key="index">
              <text class="preview-date-tag">{{date}}</text>
            </block>
            <text wx:if="{{filteredDates.length > 30}}" class="preview-more">...ç­‰{{filteredDates.length}}å¤©</text>
          </view>
        </scroll-view>
      </view>
      
      <!-- æ“ä½œæŒ‰é’® -->
      <view class="modal-actions">
        <button class="btn-modal-cancel" bindtap="hideDateRangeModal">å–æ¶ˆ</button>
        <button class="btn-modal-confirm" type="primary" bindtap="applyDateRange">ç¡®å®š</button>
      </view>
    </view>
  </tui-modal>

  <!-- æ—¥å†ç¼–è¾‘å¼¹çª— -->
  <tui-modal 
    show="{{showCalendarEditModal}}" 
    bind:cancel="hideCalendarEditModal" 
    custom="{{true}}" 
    fadein="{{true}}"
    width="90%"
    height="80%"
  >
    <view class="calendar-edit-modal">
      <view class="modal-header">
        <text class="modal-title">ç¼–è¾‘å·¥ä½œæ—¥æœŸ - {{editScheduleData ? editScheduleData.schedule_title : ''}}</text>
        <text class="selected-count">å·²é€‰ï¼š{{editSelectedDates.length}}å¤©</text>
      </view>
      
      <!-- ç¼–è¾‘æ—¥å†å¯¼èˆª -->
      <view class="calendar-nav edit-calendar-nav">
        <text class="nav-btn" bindtap="prevEditMonth">â€¹</text>
        <text class="current-month">{{editCalendarYear}}å¹´{{editCalendarMonth}}æœˆ</text>
        <text class="nav-btn" bindtap="nextEditMonth">â€º</text>
      </view>
      
      <!-- ç¼–è¾‘æ—¥å†æ˜ŸæœŸå¤´éƒ¨ -->
      <view class="week-header">
        <text class="week-day">ä¸€</text>
        <text class="week-day">äºŒ</text>
        <text class="week-day">ä¸‰</text>
        <text class="week-day">å››</text>
        <text class="week-day">äº”</text>
        <text class="week-day">å…­</text>
        <text class="week-day">æ—¥</text>
      </view>
      
      <!-- ç¼–è¾‘æ—¥å†ç½‘æ ¼ -->
      <view class="edit-calendar-grid">
        <block wx:for="{{editCalendarDays}}" wx:key="index">
          <view 
            class="edit-calendar-day {{item.isCurrentMonth ? 'current-month' : 'other-month'}} {{item.isSelected ? 'selected' : ''}}"
            bindtap="selectEditDate"
            data-index="{{index}}"
            data-datestr="{{item.dateStr}}"
          >
            <text class="day-text">{{item.day}}</text>
          </view>
        </block>
      </view>
      
      <!-- å¿«é€Ÿæ“ä½œæŒ‰é’® -->
      <view class="quick-actions">
        <button class="btn-quick" size="mini" bindtap="selectAllInEditCalendar">å…¨é€‰æœ¬æœˆ</button>
        <button class="btn-quick" size="mini" bindtap="clearAllInEditCalendar">æ¸…ç©ºé€‰æ‹©</button>
      </view>
      
      <!-- å·²é€‰æ—¥æœŸé¢„è§ˆ -->
      <view class="selected-preview">
        <text class="preview-title">å·²é€‰æ—¥æœŸï¼š</text>
        <scroll-view scroll-y class="selected-dates-scroll" style="max-height: 150rpx;">
          <view class="selected-dates-grid">
            <block wx:for="{{editSelectedDates}}" wx:key="index">
              <text class="selected-date-tag">{{item}}</text>
            </block>
            <text wx:if="{{editSelectedDates.length === 0}}" class="empty-tip">æš‚æ— é€‰æ‹©æ—¥æœŸ</text>
          </view>
        </scroll-view>
      </view>
      
      <!-- æ“ä½œæŒ‰é’® -->
      <view class="modal-actions">
        <button class="btn-modal-cancel" bindtap="hideCalendarEditModal">å–æ¶ˆ</button>
        <button class="btn-modal-save" type="primary" bindtap="saveCalendarEdit">ä¿å­˜ä¿®æ”¹</button>
      </view>
    </view>
  </tui-modal>

  <!-- ç¼–è¾‘å¼¹çª— -->
  <tui-modal show="{{showEditModal}}" bind:cancel="hideEditModal" custom="{{true}}" fadein="{{true}}">
    <view style="text-align: center; padding: 40rpx;">
      <view style="padding-bottom: 30rpx; font-size: 34rpx; color: #333;">ä¿®æ”¹å†…å®¹</view>
      <form bindsubmit="saveEdit">
        <input 
          name="value" 
          type="text" 
          placeholder="{{editData[editField]}}"
          style="margin: 30rpx 40rpx; border-bottom: 1rpx solid #e6e6e6; padding-bottom: 20rpx; font-size: 32rpx;"
          value="{{editData[editField]}}"
        />
        <button 
          form-type="submit" 
          style="width:75%; margin-top: 30rpx;" 
          class="btn-primary" 
          hover-class="btn-hover"
        >
          æäº¤ä¿®æ”¹
        </button>
      </form>
    </view>
  </tui-modal>
</view>